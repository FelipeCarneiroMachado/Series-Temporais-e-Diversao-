---
title: "trabalho"
output: html_document
---

# Trabalho final de Séries Temporais e Aprendizado Dinâmico

Realizado por: - Felipe Carneiro Machado - Thales Sena de Queiroz - Felipe de Castro Azambuja

## Importação de pacotes

```{r}
library(tidyverse, quietly = TRUE)
library(ggplot2, quietly = TRUE)
library(broom, quietly = TRUE)
library(plotly, quietly = TRUE)
library(forecast, quietly = TRUE)
```

Serão analisadas séries temporais de criminalidade em São Paulo.

```{r}
taxa_delito_estado_sp <-  readxl::read_xlsx("../data/TaxaDelito-EstadoSP_20251020_211705.xlsx")
indicadores_seguranca_publica_uf <- readxl::read_excel("../data/indicadoressegurancapublicauf.xlsx")
```

O primeiro dataset contem o numero de ocorrencias anuais de certos tipos de crime apenas para SP. O segundo possui resolucao de meses para todos os estados brasileiros. Iremos fazer o recorte para o estado de SP.

```{r}
meses<- c('janeiro' = 1,'fevereiro' = 2,'março' = 3,'abril' = 4,'maio' =5,'junho' = 6 , 'julho'=7,'agosto'=8,'setembro'=9,'outubro'=10,'novembro'=11,'dezembro'=12)

crimes_mensal_sp_wide <- indicadores_seguranca_publica_uf |> 
  filter(UF == "São Paulo") |> 
  pivot_wider(
    names_from = c(`Tipo Crime`),
    values_from= Ocorrências
  ) |> 
  mutate(
    Mes_num = meses[str_trim(Mês)],
    Data = make_date(year = Ano, month = Mes_num)
  ) |> 
  select(
    !c(Ano, Mês, Mes_num, UF)
  ) |> 
  arrange(Data) |> 
  replace_na(list(`Lesão corporal seguida de morte` = 0))

crimes_mensal_sp_long <- crimes_mensal_sp_wide |> 
  pivot_longer(
    cols=!c(Data),
    names_to = "Tipo.crime",
    values_to = "Ocorrencia"
  )
```

Vamos plotar as series para visualizar as variacoes no tempo

```{r}
crimes_mensal_sp_wide |>
  pivot_longer(
    cols=!c(Data),
    names_to = "Tipo.crime",
    values_to = "Ocorrencia"
  ) |> 
  ggplot(aes(x = Data, y = Ocorrencia, color = `Tipo.crime`)) +
  geom_line()
```

Nota-se que furto e roubo de veiculos tem maiores valores, com sazonalidade mais aparente a primeira vista. Outros crimes tem valores mais constantes, sendo necessario visualizacao mais proxima

```{r}
crimes_mensal_sp_wide |>
  select(!c(`Roubo de veículo`, `Furto de veículo`)) |> 
  pivot_longer(
    cols=!c(Data),
    names_to = "Tipo.crime",
    values_to = "Ocorrencia"
  ) |> 
  ggplot(aes(x = Data, y = Ocorrencia, color = `Tipo.crime`)) +
  geom_line()
```

Observaremos primeiro a serie de Roubo de Veicuos

```{r}
crimes_mensal_sp_wide |> 
  filter(Data >= "2015-01-01" & Data <= "2020-01-01") |> 
  ggplot(aes(x = Data, y = `Roubo de veículo`))+
  geom_line() +
  scale_x_date(
    NULL,
    breaks = scales::breaks_width("6 month"),
    labels = scales::label_date("%y-%m")
  )
```

Aparenta-se que existe sazonalidade, observe picos proximos de outubro

## Analise geral de ACF e PACF

```{r}
roubos_ts <- crimes_mensal_sp_wide$`Roubo de veículo` |> 
  ts(start = c(2015, 1), end = c(2022, 8), frequency = 12)
acf(roubos_ts)
pacf(roubos_ts)
```

Nota-se que a ACF possui valores que decaindo, e a PACF possui poucos picos, sendo um na marca de um ano, indicando sazonalidade.

## Ajuste com modelo de Holt-Winters

```{r}
# Separacao de treino e teste 2015-2020 de treino, 2021-2022 de teste

train.roubos_ts <- window(roubos_ts, start = c(2015, 1), end = c(2018, 12))
test.roubos_ts <- window(roubos_ts, start = c(2018, 12), end = c(2020, 2))
hw.fit <- HoltWinters(train.roubos_ts, seasonal = "additive")
plot(hw.fit)
cat(sprintf("Holt-Winters ajustado\n"))
cat(sprintf("MSE = %f\n", hw.fit$SSE / length(train.roubos_ts)))
cat(sprintf("alpha = %f\n", hw.fit$alpha))
cat(sprintf("beta = %f\n", hw.fit$beta))
cat(sprintf("gama = %f\n", hw.fit$gamma))
```

```{r}
hw.fit.mult <- HoltWinters(train.roubos_ts, seasonal = "multiplicative")
plot(hw.fit.mult, main = "Holt-Winters: Ajuste Multiplicativo")
mse_mult <- hw.fit.mult$SSE / length(train.roubos_ts)
mse_add <- hw.fit$SSE / length(train.roubos_ts)

cat(sprintf("MSE Aditivo: %f\n", mse_add))
cat(sprintf("MSE Multiplicativo: %f\n", mse_mult))

```

O Modelo Multiplicativo teve um error menor indicando que provavelmente a tendência e a sazonalidade possuem algum grau de proporcionalidade entre-si.

```{r}
modelo_final <- hw.fit

h <- length(test.roubos_ts)
previsao <- predict(modelo_final, n.ahead = h, prediction.interval = TRUE)

plot(roubos_ts, main = "Holt-Winters: Previsão vs Real", ylab = "Roubos", xlab = "Tempo")

lines(previsao[, "fit"], col = "red", lwd = 2)

lines(previsao[, "upr"], col = "red", lty = 2)
lines(previsao[, "lwr"], col = "red", lty = 2)

lines(test.roubos_ts, col = "blue", lwd = 2, lty = 1)

legend("topright", legend=c("Original", "Previsão", "Teste (Real)"),
       col=c("black", "red", "blue"), lty=1, cex=0.8)

erro_teste <- test.roubos_ts - previsao[, "fit"]

rmse <- sqrt(mean(erro_teste^2))

mape <- mean(abs(erro_teste / test.roubos_ts)) * 100
  
cat(sprintf("RMSE (Erro Quadrático): %f\n", rmse))
cat(sprintf("MAPE (Erro Percentual): %.2f%%\n", mape))

modelo_final <- hw.fit.mult

h <- length(test.roubos_ts)
previsao <- predict(modelo_final, n.ahead = h, prediction.interval = TRUE)

plot(roubos_ts, main = "Holt-Winters: Previsão vs Real", ylab = "Roubos", xlab = "Tempo")

lines(previsao[, "fit"], col = "red", lwd = 2)

lines(previsao[, "upr"], col = "red", lty = 2)
lines(previsao[, "lwr"], col = "red", lty = 2)

lines(test.roubos_ts, col = "blue", lwd = 2, lty = 1)

legend("topright", legend=c("Original", "Previsão", "Teste (Real)"),
       col=c("black", "red", "blue"), lty=1, cex=0.8)

erro_teste <- test.roubos_ts - previsao[, "fit"]

rmse <- sqrt(mean(erro_teste^2))

mape <- mean(abs(erro_teste / test.roubos_ts)) * 100
  
cat(sprintf("RMSE (Erro Quadrático): %f\n", rmse))
cat(sprintf("MAPE (Erro Percentual): %.2f%%\n", mape))

```

Com um erro de 6.69% o modelo aditivo e o multiplicativo com 6.99% tornam-se aceitaveis para modelar este evento que nao demanda precisão extrema.

```{r}
modelo_sarima <- auto.arima(train.roubos_ts, seasonal = TRUE,
                            stepwise = FALSE, approximation =
                              FALSE, trace = TRUE)
summary(modelo_sarima)
```

p = 0 e q = 2, mostrando que foi detectado choques de curto prazo ao longo de 2 meses. e d = 1 pois foi necessaria uma diferenciação simples. D = 1 mostra que realmente deve haver uma sazonalidade anual. Q = 0, mostrando que apenas a diferenciação mês desse ano menos o mês do ano passado foi suficiente.

Divindio o o coeficiente da sma1 de -0.3514 e dividindo pelo erro de 0.1566 temos algo proximo de 2.24 que é maior que 2 indicando que o termo sazonal é realmente relevante, demonstrando que o modelo SARIMA pode vir a ser mais adequado do que um ARIMA.

O MAPE foi de 3,36%, realmente um desempenho extremamente superior ao de Holt-Winters, e também podendo até mesmo ser considerado excelente para esse tipo de dado que estamos tratando.

```{r}
h <- length(test.roubos_ts)
previsao_sarima <- forecast(modelo_sarima, h = h)

plot(previsao_sarima, main="Previsão SARIMA vs Dados Reais")
lines(test.roubos_ts, col="red", lwd=2)
legend("topleft", legend=c("Previsão", "Real (Teste)"), col=c("blue", "red"), lty=1)

erro_sarima <- test.roubos_ts - previsao_sarima$mean
rmse_sarima <- sqrt(mean(erro_sarima^2))
mape_sarima <- mean(abs(erro_sarima / test.roubos_ts)) * 100

cat(sprintf("\nErro do SARIMA:\nRMSE: %f\nMAPE: %.2f%%\n", rmse_sarima, mape_sarima))
```

O melhor modelo foi o Holt-Winters Aditivo portanto iremos extrair os residuos do mesmo.

```{r}
residuos_campeao <- na.omit(residuals(hw.fit))


par(mfrow=c(1,2))

acf(residuos_campeao, main="ACF - Resíduos (HW Aditivo)")

hist(residuos_campeao, main="Histograma", col="lightblue", probability=TRUE)
lines(density(residuos_campeao), col="red", lwd=2)
par(mfrow=c(1,1))


lb_test <- Box.test(residuos_campeao, type = "Ljung-Box")

cat(sprintf("\n--- RESULTADO FINAL (HW ADITIVO) ---\n"))
cat(sprintf("MAPE (Teste): 6.69%%\n"))
cat(sprintf("P-valor Ljung-Box: %.4f\n", lb_test$p.value))

if(lb_test$p.value > 0.05){
  cat("CONCLUSÃO: O modelo é ESTATISTICAMENTE VÁLIDO (Resíduos aleatórios).\n")
} else {
  cat("CONCLUSÃO: O modelo é o MELHOR PREDITOR, apesar de resíduos correlacionados.\n")
}
```

A análise comparativa indicou o método de Holt-Winters aditivo como o modelo mais adequado para a previsão da série de roubos. Após a remoção da quebra estrutural referente ao período da pandemia (2020-2021), o modelo demonstrou alta capacidade preditiva, apresentando um MAPE de 6.69% no conjunto de teste.

A validação estatística foi confirmada pela análise de resíduos: o teste de Ljung-Box resultou em um p-valor de 0.3347 (>0.05), indicando a ausência de autocorrelação serial nos resíduos. Além disso, a análise visual confirmou a normalidade dos erros. Conclui-se que o modelo é estatisticamente robusto e seguro para realizar previsões futuras.
